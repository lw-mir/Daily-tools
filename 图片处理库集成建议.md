# å›¾ç‰‡å¤„ç†åº“é›†æˆå»ºè®®

## ğŸ¯ é’ˆå¯¹å½“å‰é¡¹ç›®çš„æœ€ä½³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šwx-caman + åŸç”Ÿ APIï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯ï¼š** éœ€è¦é«˜è´¨é‡æ»¤é•œæ•ˆæœå’ŒåŸºç¡€è½¬æ¢åŠŸèƒ½

**é›†æˆæ–¹å¼ï¼š**

```bash
npm install wx-caman
```

**ä¼˜åŠ¿ï¼š**

- ä¸“ä¸ºå¾®ä¿¡å°ç¨‹åºä¼˜åŒ–
- æ»¤é•œæ•ˆæœä¸°å¯Œä¸”è´¨é‡é«˜
- ä¸ç°æœ‰ Canvas é€»è¾‘å…¼å®¹
- ç¤¾åŒºæ´»è·ƒï¼Œæ–‡æ¡£å®Œå–„

**é›†æˆæ­¥éª¤ï¼š**

1. å®‰è£…åº“ï¼š`npm install wx-caman`
2. åœ¨å¼€å‘è€…å·¥å…·ä¸­æ„å»º npm
3. æ›¿æ¢ç°æœ‰çš„ Canvas å¤„ç†é€»è¾‘

**ä»£ç ç¤ºä¾‹ï¼š**

```typescript
import WxCaman from 'wx-caman'

// æ›¿æ¢ç°æœ‰çš„æ ¼å¼è½¬æ¢æ–¹æ³•
async convertFormat(imageInfo: ImageInfo): Promise<ImageInfo> {
  return new Promise((resolve, reject) => {
    const { outputFormat, outputQuality } = this.data

    // å…ˆç»˜åˆ¶åŸå›¾åˆ°Canvas
    const query = wx.createSelectorQuery().in(this)
    query.select('#imageCanvas').fields({ node: true, size: true }).exec((res) => {
      const canvas = res[0].node
      const ctx = canvas.getContext('2d')

      // è®¾ç½®Canvaså°ºå¯¸
      canvas.width = imageInfo.width
      canvas.height = imageInfo.height

      const img = canvas.createImage()
      img.onload = () => {
        ctx.drawImage(img, 0, 0, imageInfo.width, imageInfo.height)

        // ä½¿ç”¨wx-camanè¿›è¡Œå¤„ç†
        new WxCaman('imageCanvas', imageInfo.width, imageInfo.height, function () {
          // æ ¹æ®éœ€è¦åº”ç”¨æ»¤é•œ
          if (outputQuality < 100) {
            this.brightness(outputQuality - 100) // ç®€å•çš„è´¨é‡è°ƒèŠ‚
          }

          this.render(() => {
            // å¯¼å‡ºå¤„ç†åçš„å›¾ç‰‡
            wx.canvasToTempFilePath({
              canvas: canvas,
              fileType: outputFormat,
              quality: outputQuality / 100,
              success: (res) => {
                // è·å–å¤„ç†åå›¾ç‰‡ä¿¡æ¯
                this.getProcessedImageInfo(res.tempFilePath, outputFormat, `${this.data.outputFileName}.${outputFormat}`, resolve, reject)
              },
              fail: reject
            })
          })
        })
      }
      img.src = imageInfo.path
    })
  })
}
```

### æ–¹æ¡ˆäºŒï¼šmp-image-compress + åŸç”Ÿ Canvas

**é€‚ç”¨åœºæ™¯ï¼š** ä¸»è¦éœ€æ±‚æ˜¯å‹ç¼©å’ŒåŸºç¡€è½¬æ¢

**é›†æˆæ–¹å¼ï¼š**

```bash
npm install mp-image-compress
```

**ä»£ç ç¤ºä¾‹ï¼š**

```typescript
import mpImageCompress from 'mp-image-compress'

// å‹ç¼©åŠŸèƒ½çš„å¢å¼ºç‰ˆæœ¬
async compressImage(imageInfo: ImageInfo): Promise<ImageInfo> {
  const { outputQuality } = this.data

  // è®¡ç®—ç›®æ ‡å¤§å°ï¼ˆKBï¼‰
  const targetSizeKB = Math.round((imageInfo.size / 1024) * (outputQuality / 100))

  try {
    const compressedResult = await mpImageCompress.set(imageInfo.path, targetSizeKB)

    return {
      path: compressedResult.filePath,
      format: imageInfo.format,
      name: `${this.data.outputFileName}_compressed`,
      width: compressedResult.width,
      height: compressedResult.height,
      size: compressedResult.size,
      sizeText: this.formatFileSize(compressedResult.size)
    }
  } catch (error) {
    throw new Error('å‹ç¼©å¤±è´¥: ' + error.message)
  }
}
```

### æ–¹æ¡ˆä¸‰ï¼šæ··åˆæ–¹æ¡ˆï¼ˆæœ€ä½³å®è·µï¼‰

**ç»“åˆå¤šä¸ªåº“çš„ä¼˜åŠ¿ï¼š**

```typescript
// æ ¹æ®å¤„ç†ç±»å‹é€‰æ‹©ä¸åŒçš„åº“
async processImage(imageInfo: ImageInfo): Promise<ImageInfo> {
  const { processingMode } = this.data

  switch (processingMode) {
    case 'format':
      return this.convertFormatWithCaman(imageInfo)
    case 'compress':
      return this.compressWithMpCompress(imageInfo)
    case 'crop':
      return this.cropWithCanvas(imageInfo) // ä¿æŒåŸæœ‰å®ç°
    case 'rename':
      return this.renameImage(imageInfo) // ä¿æŒåŸæœ‰å®ç°
    default:
      throw new Error('æœªçŸ¥çš„å¤„ç†æ¨¡å¼')
  }
}
```

## ğŸš€ é›†æˆæ­¥éª¤

### 1. å®‰è£…ä¾èµ–

```bash
# ä¸»è¦æ¨è
npm install wx-caman

# å¯é€‰çš„å‹ç¼©åº“
npm install mp-image-compress
```

### 2. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æ„å»º npm

å·¥å…· â†’ æ„å»º npm

### 3. åœ¨é¡¹ç›®ä¸­å¼•å…¥

```typescript
// åœ¨imageconverter.tsé¡¶éƒ¨æ·»åŠ 
import WxCaman from "wx-caman";
import mpImageCompress from "mp-image-compress";
```

### 4. é€æ­¥æ›¿æ¢ç°æœ‰é€»è¾‘

- å…ˆæ›¿æ¢æ ¼å¼è½¬æ¢åŠŸèƒ½
- å†ä¼˜åŒ–å‹ç¼©åŠŸèƒ½
- ä¿æŒè£å‰ªå’Œé‡å‘½åçš„åŸæœ‰å®ç°

## ğŸ“Š å¯¹æ¯”åˆ†æ

| åŠŸèƒ½     | å½“å‰å®ç° | wx-caman   | mp-image-compress |
| -------- | -------- | ---------- | ----------------- |
| æ ¼å¼è½¬æ¢ | åŸºç¡€     | â­â­â­â­â­ | â­â­â­            |
| å›¾ç‰‡å‹ç¼© | åŸºç¡€     | â­â­â­     | â­â­â­â­â­        |
| æ»¤é•œæ•ˆæœ | æ—        | â­â­â­â­â­ | â­                |
| è£å‰ªåŠŸèƒ½ | â­â­â­â­ | â­â­       | â­                |
| åº“å¤§å°   | 0        | ä¸­ç­‰       | å°                |
| å­¦ä¹ æˆæœ¬ | æ—        | ä½         | å¾ˆä½              |

## ğŸ¨ å¢å¼ºåŠŸèƒ½å»ºè®®

ä½¿ç”¨è¿™äº›åº“åï¼Œä½ å¯ä»¥ä¸ºå›¾ç‰‡è½¬æ¢å™¨æ·»åŠ æ›´å¤šåŠŸèƒ½ï¼š

### 1. æ»¤é•œæ•ˆæœ

```typescript
// æ·»åŠ æ»¤é•œé€‰é¡¹
data: {
  filterOptions: [
    { name: 'æ— æ»¤é•œ', value: 'none' },
    { name: 'å¤å¤', value: 'vintage' },
    { name: 'é»‘ç™½', value: 'greyscale' },
    { name: 'æ€€æ—§', value: 'sepia' },
    { name: 'é²œè‰³', value: 'vibrance' }
  ],
  selectedFilter: 'none'
}
```

### 2. é«˜çº§å‹ç¼©é€‰é¡¹

```typescript
// æ›´ç²¾ç¡®çš„å‹ç¼©æ§åˆ¶
data: {
  compressionOptions: {
    targetSize: 1024, // KB
    maxWidth: 1920,
    maxHeight: 1080,
    maintainAspectRatio: true
  }
}
```

### 3. æ‰¹é‡å¤„ç†

```typescript
// æ”¯æŒå¤šå›¾ç‰‡æ‰¹é‡å¤„ç†
async processBatchImages(imageList: ImageInfo[]): Promise<ImageInfo[]> {
  const results = []
  for (const image of imageList) {
    const processed = await this.processImage(image)
    results.push(processed)
  }
  return results
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½è€ƒè™‘**ï¼šå›¾ç‰‡å¤„ç†æ˜¯ CPU å¯†é›†å‹æ“ä½œï¼Œå¤§å›¾ç‰‡å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´
2. **å†…å­˜ç®¡ç†**ï¼šåŠæ—¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œé¿å…å†…å­˜æ³„æ¼
3. **é”™è¯¯å¤„ç†**ï¼šä¸ºæ¯ä¸ªå¤„ç†æ­¥éª¤æ·»åŠ å®Œå–„çš„é”™è¯¯å¤„ç†
4. **ç”¨æˆ·ä½“éªŒ**ï¼šæ·»åŠ å¤„ç†è¿›åº¦æç¤ºï¼Œé¿å…ç”¨æˆ·ç­‰å¾…ç„¦è™‘

## ğŸ”„ è¿ç§»è®¡åˆ’

### é˜¶æ®µä¸€ï¼šé›†æˆ wx-camanï¼ˆ1-2 å¤©ï¼‰

- å®‰è£…å’Œé…ç½® wx-caman
- æ›¿æ¢æ ¼å¼è½¬æ¢é€»è¾‘
- æµ‹è¯•åŸºç¡€åŠŸèƒ½

### é˜¶æ®µäºŒï¼šä¼˜åŒ–å‹ç¼©åŠŸèƒ½ï¼ˆ1 å¤©ï¼‰

- é›†æˆ mp-image-compress
- ä¼˜åŒ–å‹ç¼©ç®—æ³•
- æ·»åŠ å‹ç¼©é¢„è§ˆ

### é˜¶æ®µä¸‰ï¼šåŠŸèƒ½å¢å¼ºï¼ˆ2-3 å¤©ï¼‰

- æ·»åŠ æ»¤é•œé€‰é¡¹
- ä¼˜åŒ–ç”¨æˆ·ç•Œé¢
- å®Œå–„é”™è¯¯å¤„ç†

### é˜¶æ®µå››ï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1-2 å¤©ï¼‰

- å…¨é¢æµ‹è¯•å„ç§åœºæ™¯
- æ€§èƒ½ä¼˜åŒ–
- ç”¨æˆ·ä½“éªŒæ”¹è¿›
