# 微信小程序授权使用指南

## 功能概述

本项目实现了完整的微信小程序用户授权流程，包括：

1. **首次授权**：用户首次使用时显示授权页面
2. **授权弹框**：使用 `wx.getUserProfile` 获取用户头像和昵称
3. **信息展示**：在个人中心页面展示用户信息
4. **状态管理**：自动管理登录状态和过期时间

## 授权流程

### 1. 应用启动检查

- 应用启动时自动检查用户登录状态
- 如果未登录，跳转到授权页面 (`/pages/auth/auth`)
- 如果已登录，直接进入首页

### 2. 授权页面功能

- **主要授权按钮**：触发微信官方授权弹框
- **测试授权按钮**：用于测试授权功能是否正常
- **调试信息**：显示授权状态和错误信息
- **跳过登录**：允许用户以游客模式使用

### 3. 授权弹框

- 使用 `wx.getUserProfile` API
- 弹框内容：获取用户昵称、头像、地区及性别
- 用户可以选择"允许"或"拒绝"

### 4. 信息展示

- 授权成功后跳转到个人中心页面
- 显示用户头像、昵称、登录时间等信息
- 提供用户信息详情查看功能

## 技术实现

### 核心文件

1. **授权页面**

   - `pages/auth/auth.ts` - 授权逻辑
   - `pages/auth/auth.wxml` - 授权界面
   - `pages/auth/auth.wxss` - 授权样式

2. **授权管理器**

   - `utils/authManager.ts` - 核心授权管理类
   - 处理登录、登出、状态检查等功能

3. **个人中心页面**
   - `pages/profile/profile.ts` - 个人中心逻辑
   - `pages/profile/profile.wxml` - 个人中心界面
   - 展示用户信息和提供登录/登出功能

### 关键 API 使用

```typescript
// 检查是否支持 getUserProfile
if (wx.canIUse("getUserProfile")) {
  // 调用授权弹框
  wx.getUserProfile({
    desc: "用于完善用户资料",
    success: (res) => {
      // 获取用户信息成功
      console.log("用户信息:", res.userInfo);
    },
    fail: (error) => {
      // 用户拒绝授权
      console.log("授权失败:", error);
    },
  });
}
```

## 使用方法

### 1. 开发者工具测试

1. 打开微信开发者工具
2. 导入项目
3. 点击"编译"按钮
4. 在模拟器中测试授权流程

### 2. 真机测试

1. 点击"预览"按钮生成二维码
2. 使用微信扫描二维码
3. 在真机上测试授权弹框

### 3. 授权测试步骤

1. **清除登录状态**

   - 在个人中心点击"退出登录"
   - 或者清除小程序数据

2. **测试授权流程**

   - 重新进入小程序
   - 应该自动跳转到授权页面
   - 点击"微信授权登录"按钮
   - 查看是否弹出授权弹框

3. **验证信息展示**
   - 授权成功后应跳转到个人中心
   - 检查用户头像和昵称是否正确显示
   - 点击"详情"按钮查看完整用户信息

## 常见问题

### 1. 授权弹框不显示

**原因**：

- 微信版本过低，不支持 `getUserProfile`
- 开发者工具版本问题
- 代码调用方式不正确

**解决方法**：

- 更新微信到最新版本
- 更新开发者工具到最新版本
- 检查代码中是否正确调用 `wx.getUserProfile`

### 2. 授权成功但信息不显示

**原因**：

- 用户信息保存失败
- 页面数据绑定问题
- 头像 URL 加载失败

**解决方法**：

- 检查控制台日志
- 验证数据存储逻辑
- 检查网络连接

### 3. 重复授权问题

**原因**：

- 登录状态管理不当
- 本地存储清除问题

**解决方法**：

- 检查 `AuthManager` 的状态管理逻辑
- 确保登录状态正确保存和读取

## 调试技巧

### 1. 使用调试信息

- 在授权页面点击"显示调试信息"
- 查看微信版本支持情况
- 检查授权状态和错误信息

### 2. 控制台日志

- 打开开发者工具控制台
- 查看详细的授权流程日志
- 关注错误信息和警告

### 3. 网络请求

- 检查网络面板
- 确保没有网络请求错误
- 验证头像 URL 是否可访问

## 注意事项

1. **用户体验**

   - 授权弹框只能由用户主动触发
   - 不要在页面加载时立即调用授权
   - 提供清晰的授权说明

2. **隐私保护**

   - 明确说明获取用户信息的用途
   - 遵守微信小程序隐私政策
   - 不要过度收集用户信息

3. **兼容性**
   - 始终检查 `wx.canIUse('getUserProfile')`
   - 为不支持的版本提供降级方案
   - 测试不同微信版本的兼容性

## 更新日志

- **v1.0.0** - 初始版本，实现基本授权流程
- **v1.1.0** - 添加调试信息和错误处理
- **v1.2.0** - 优化用户体验和界面设计

## 技术支持

如果遇到问题，请：

1. 查看控制台日志
2. 检查微信版本和开发者工具版本
3. 参考本文档的常见问题部分
4. 联系开发团队获取支持
